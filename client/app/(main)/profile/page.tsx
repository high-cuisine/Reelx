'use client'
import cls from './profile.module.scss';
import Image from 'next/image';
import ton from '@/assets/ton.svg';
import {getAvatarColor} from '@/shared/helpers/getAvatarColor'
import { Deposit } from './components/deposit/deposit';
import { Promocodes } from './components/promocodes/promocodes';
import { useState, useEffect } from 'react';

import copyImage from '@/assets/copyId.svg'

const ProfilePage = () => {
    const [usernameInitial, setUsernameInitial] = useState('T'); // fallback
    const [photoUrl, setPhotoUrl] = useState<string | null>(null);

    useEffect(() => {
        const initTelegram = () => {
            if (typeof window === 'undefined' || !window.Telegram?.WebApp) {
                return;
            }

            // Вызываем ready() для инициализации WebApp
            window.Telegram.WebApp.ready();
            
            const user = window.Telegram.WebApp.initDataUnsafe?.user;
            if (user) {
                const username = user.username;
                const initial = (username || 'T').slice(0, 1).toUpperCase();
                setUsernameInitial(initial);

                // Парсим initData для получения photo_url
                try {
                    const initData = window.Telegram.WebApp.initData;
                    const params = new URLSearchParams(initData);
                    const userParam = params.get('user');
                    if (userParam) {
                        const userData = JSON.parse(decodeURIComponent(userParam));
                        if (userData.photo_url) {
                            setPhotoUrl(`https://reelx.online/api/users/photo/${userData.photo_url}`);
                        }
                    }
                } catch (e) {
                    console.warn('Failed to parse photo_url from initData:', e);
                }
            }
        };

        // Проверяем сразу и при загрузке скрипта
        if (typeof window !== 'undefined') {
            if (document.readyState === 'complete') {
                initTelegram();
            } else {
                window.addEventListener('load', initTelegram);
            }

            // Также проверяем через интервал на случай, если скрипт загрузится позже
            const checkInterval = setInterval(() => {
                if (window.Telegram?.WebApp) {
                    clearInterval(checkInterval);
                    initTelegram();
                }
            }, 100);

            // Очищаем интервал через 5 секунд
            setTimeout(() => {
                clearInterval(checkInterval);
            }, 5000);

            return () => {
                window.removeEventListener('load', initTelegram);
                clearInterval(checkInterval);
            };
        }
    }, []);

  return (
    <div className={cls.profile}>
        <a className={cls.support}>
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6.09912 0C8.53158 0.000202201 10.5079 2.02497 10.5298 4.51562L11.0679 4.79492H11.0708L11.105 4.8125C11.9163 5.23503 12.3464 6.16633 12.1548 7.07715L11.9038 8.26855C11.7054 9.20426 10.8849 9.88574 9.95068 9.88574H9.49268L9.32764 10.6094C9.11874 11.5427 8.31994 12.1992 7.38135 12.1992H5.91357C5.63646 12.199 5.41573 11.9685 5.41553 11.6904C5.41553 11.4122 5.63633 11.1809 5.91357 11.1807H7.38135C7.85012 11.1807 8.25223 10.8526 8.35693 10.3789V10.3779L8.61377 9.25977L8.6167 9.24512V9.24414L9.42334 5.41309L9.42432 5.41113C9.50077 5.08385 9.53562 4.81661 9.53564 4.55762C9.53564 2.60328 7.99171 1.01855 6.09912 1.01855C4.20664 1.01868 2.6626 2.60337 2.6626 4.55762C2.66262 4.81665 2.69787 5.08376 2.77295 5.40039L2.77393 5.40332L3.58936 9.26953L3.6001 9.38281C3.59858 9.49604 3.55992 9.60671 3.49072 9.69629H3.48975C3.39488 9.81612 3.25385 9.88672 3.10107 9.88672H2.24951C1.31239 9.8867 0.494701 9.20512 0.297363 8.26953L0.0454102 7.07812C-0.146931 6.16731 0.284074 5.23609 1.09521 4.81348L1.66748 4.51562C1.6894 2.02486 3.66651 2.3677e-05 6.09912 0ZM7.38135 12.0996C7.43556 12.0996 7.48933 12.0973 7.54248 12.0928C7.48944 12.0973 7.43545 12.0996 7.38135 12.0996ZM5.8374 12.0908C5.86213 12.0958 5.88745 12.0996 5.91357 12.0996C5.88745 12.0996 5.86213 12.0958 5.8374 12.0908ZM5.76807 12.0703C5.78226 12.0761 5.79708 12.0799 5.81201 12.084C5.79708 12.0799 5.78226 12.0761 5.76807 12.0703ZM7.64209 12.0801C7.65809 12.0778 7.67407 12.0759 7.68994 12.0732C7.67407 12.0759 7.65809 12.0778 7.64209 12.0801ZM5.69873 12.0332C5.71247 12.0424 5.72687 12.0502 5.7417 12.0576C5.72686 12.0502 5.71248 12.0424 5.69873 12.0332ZM7.77197 12.0566C7.79949 12.0508 7.82692 12.0452 7.854 12.0381C7.82692 12.0451 7.79949 12.0508 7.77197 12.0566ZM7.8999 12.0244C7.93475 12.0144 7.96939 12.0042 8.00342 11.9922C7.96939 12.0042 7.93475 12.0144 7.8999 12.0244ZM5.64307 11.9883C5.65544 12.0002 5.66837 12.0113 5.68213 12.0215C5.66836 12.0113 5.65544 12.0002 5.64307 11.9883ZM8.05127 11.9736C8.08379 11.9611 8.11628 11.9489 8.14795 11.9346C8.11628 11.9488 8.08379 11.9611 8.05127 11.9736ZM5.59717 11.9365C5.60544 11.9478 5.61421 11.9585 5.62354 11.9688C5.61421 11.9585 5.60544 11.9478 5.59717 11.9365ZM8.19971 11.9092C8.22644 11.8961 8.25277 11.8825 8.27881 11.8682C8.25277 11.8825 8.22645 11.8961 8.19971 11.9092ZM5.55811 11.8711C5.56422 11.8838 5.57033 11.8963 5.57764 11.9082C5.57033 11.8963 5.56422 11.8838 5.55811 11.8711ZM5.52393 11.7725C5.5289 11.7975 5.53621 11.8216 5.54541 11.8447C5.53621 11.8216 5.52891 11.7975 5.52393 11.7725ZM8.34033 11.832C8.36368 11.818 8.38697 11.8041 8.40967 11.7891C8.38696 11.8041 8.36368 11.818 8.34033 11.832ZM8.47021 11.7471C8.491 11.7321 8.51157 11.717 8.53174 11.7012C8.51156 11.717 8.49101 11.7321 8.47021 11.7471ZM5.52393 11.6084V11.6074V11.6084ZM8.59326 11.6514C8.61098 11.6363 8.62785 11.6203 8.64502 11.6045C8.62785 11.6203 8.61098 11.6363 8.59326 11.6514ZM8.70361 11.5498C8.72283 11.5306 8.74086 11.5103 8.75928 11.4902C8.74085 11.5103 8.72283 11.5306 8.70361 11.5498ZM8.80713 11.4375C8.82739 11.4137 8.84658 11.3891 8.86572 11.3643C8.84657 11.3891 8.82739 11.4137 8.80713 11.4375ZM8.90576 11.3125C8.91997 11.2927 8.93328 11.2723 8.94678 11.252C8.93328 11.2723 8.91997 11.2927 8.90576 11.3125ZM3.10107 9.78711C3.12975 9.78711 3.15767 9.78241 3.18506 9.77637C3.15778 9.78237 3.12968 9.78711 3.10107 9.78711ZM9.95068 9.78613C10.0042 9.78613 10.0572 9.78296 10.1099 9.77832C10.0573 9.78294 10.0041 9.78613 9.95068 9.78613ZM3.1958 9.77344C3.21879 9.76767 3.24072 9.75979 3.26221 9.75C3.24073 9.7598 3.21879 9.76768 3.1958 9.77344ZM10.2183 9.76465C10.2316 9.76265 10.245 9.76108 10.2583 9.75879C10.245 9.76107 10.2316 9.76266 10.2183 9.76465ZM10.354 9.73828C10.3748 9.73353 10.3959 9.73007 10.4165 9.72461C10.3959 9.73007 10.3748 9.73354 10.354 9.73828ZM1.78174 9.72559C1.78845 9.72736 1.79551 9.72779 1.80225 9.72949C1.79551 9.72779 1.78845 9.72736 1.78174 9.72559ZM10.4956 9.7002C10.5198 9.6926 10.544 9.68532 10.5679 9.67676C10.544 9.68532 10.5198 9.6926 10.4956 9.7002ZM1.63623 9.67969C1.64079 9.68131 1.64533 9.68298 1.6499 9.68457C1.64533 9.68298 1.64079 9.68131 1.63623 9.67969ZM10.6353 9.65039C10.6595 9.64059 10.6837 9.63091 10.7075 9.62012C10.6837 9.63091 10.6595 9.64059 10.6353 9.65039ZM1.48779 9.61914C1.49947 9.62446 1.51116 9.62968 1.52295 9.63477C1.51116 9.62968 1.49947 9.62446 1.48779 9.61914ZM10.7808 9.58398C10.8055 9.57146 10.8299 9.55852 10.854 9.54492C10.8299 9.55852 10.8055 9.57146 10.7808 9.58398ZM1.34619 9.54785C1.36703 9.55955 1.3884 9.57015 1.40967 9.58105C1.3884 9.57015 1.36703 9.55955 1.34619 9.54785ZM10.9067 9.51465C10.9326 9.49901 10.9579 9.48267 10.9829 9.46582C10.9579 9.48267 10.9326 9.499 10.9067 9.51465ZM1.21729 9.46777C1.23567 9.48011 1.25415 9.49221 1.27295 9.50391C1.25415 9.49221 1.23567 9.48011 1.21729 9.46777ZM11.0415 9.42578C11.0642 9.40927 11.0859 9.39153 11.1079 9.37402C11.0859 9.39153 11.0642 9.40927 11.0415 9.42578ZM1.09814 9.38184C1.11038 9.39148 1.1228 9.40082 1.13525 9.41016C1.1228 9.40082 1.11038 9.39148 1.09814 9.38184ZM11.1685 9.32422C11.1868 9.30839 11.2044 9.29191 11.2222 9.27539C11.2044 9.29191 11.1868 9.30839 11.1685 9.32422ZM0.968262 9.26953C0.984371 9.28472 1.00049 9.29984 1.01709 9.31445C1.00049 9.29984 0.984374 9.28472 0.968262 9.26953ZM11.2749 9.22559C11.3029 9.19754 11.3297 9.16845 11.356 9.13867C11.3297 9.16845 11.3029 9.19754 11.2749 9.22559ZM0.86377 9.16309C0.880066 9.181 0.896652 9.19856 0.913574 9.21582C0.89665 9.19855 0.880069 9.181 0.86377 9.16309ZM11.3745 9.11816C11.3976 9.09129 11.4193 9.06334 11.4409 9.03516C11.4193 9.06334 11.3976 9.09128 11.3745 9.11816ZM0.76416 9.04492C0.778658 9.06364 0.792972 9.08245 0.808105 9.10059C0.792969 9.08245 0.778661 9.06364 0.76416 9.04492ZM11.4819 8.98145C11.501 8.95473 11.5188 8.92716 11.5366 8.89941C11.5188 8.92716 11.501 8.95473 11.4819 8.98145ZM0.680176 8.92676C0.689012 8.9401 0.697399 8.9537 0.706543 8.9668C0.697397 8.9537 0.689014 8.9401 0.680176 8.92676ZM11.5679 8.84863C11.5834 8.82265 11.5984 8.79633 11.6128 8.76953C11.5984 8.79633 11.5834 8.82264 11.5679 8.84863ZM0.597168 8.79004C0.605965 8.80602 0.614319 8.8222 0.623535 8.83789C0.614317 8.8222 0.605967 8.80602 0.597168 8.79004ZM0.527832 8.65137C0.535159 8.6676 0.541574 8.68422 0.549316 8.7002C0.541572 8.68421 0.535161 8.6676 0.527832 8.65137ZM11.7075 8.57031C11.6907 8.61245 11.6724 8.65379 11.6528 8.69434C11.6739 8.65066 11.6935 8.60607 11.7114 8.56055L11.7075 8.57031ZM11.8052 8.24805C11.7934 8.30371 11.7795 8.35845 11.7632 8.41211L11.8062 8.24805L12.0571 7.05664L11.8052 8.24805ZM0.115723 6.89453C0.109242 6.84334 0.104552 6.7922 0.102051 6.74121C0.104546 6.79221 0.109245 6.84334 0.115723 6.89453ZM0.101074 6.58203C0.0999925 6.61708 0.100298 6.65223 0.101074 6.6875C0.100294 6.65224 0.0999983 6.61708 0.101074 6.58203ZM0.11377 6.41309C0.110228 6.44355 0.108098 6.47417 0.105957 6.50488C0.108092 6.47417 0.110234 6.44354 0.11377 6.41309ZM0.135254 6.27246C0.130174 6.29931 0.126543 6.3264 0.122559 6.35352C0.126537 6.3264 0.13018 6.29931 0.135254 6.27246ZM0.168457 6.12402C0.160722 6.15274 0.15441 6.18184 0.147949 6.21094C0.154404 6.18184 0.160728 6.15274 0.168457 6.12402ZM0.212402 5.98438C0.205401 6.00439 0.199239 6.02467 0.192871 6.04492C0.199235 6.02467 0.205405 6.00439 0.212402 5.98438ZM0.27002 5.83887C0.259316 5.86315 0.248504 5.88739 0.23877 5.91211C0.248499 5.88739 0.25932 5.86315 0.27002 5.83887ZM11.7612 5.53027C11.8198 5.61713 11.8715 5.70855 11.9155 5.80371C11.8714 5.70856 11.8198 5.61712 11.7612 5.53027ZM0.333496 5.70703C0.321666 5.72926 0.310296 5.75173 0.299316 5.77441C0.310293 5.75173 0.321669 5.72927 0.333496 5.70703ZM0.412598 5.57324C0.401269 5.591 0.390147 5.60884 0.379395 5.62695C0.390144 5.60884 0.401272 5.591 0.412598 5.57324ZM0.510254 5.43359C0.489807 5.46021 0.469717 5.48704 0.450684 5.51465C0.469714 5.48704 0.489809 5.46021 0.510254 5.43359ZM11.5649 5.28516C11.6011 5.32355 11.6357 5.3632 11.6685 5.4043L11.5659 5.28516C11.5299 5.24683 11.4919 5.21019 11.4526 5.1748L11.5649 5.28516ZM0.60498 5.31934C0.583538 5.34321 0.561701 5.36673 0.541504 5.3916C0.561699 5.36673 0.583539 5.34321 0.60498 5.31934ZM0.728027 5.19434C0.699443 5.22084 0.670872 5.24729 0.644043 5.27539C0.670871 5.24729 0.699443 5.22084 0.728027 5.19434ZM0.871582 5.07324C0.83236 5.103 0.793898 5.13352 0.757324 5.16602C0.793897 5.13352 0.832358 5.103 0.871582 5.07324ZM0.878418 5.06738C0.87618 5.06906 0.873812 5.07057 0.871582 5.07227C0.913355 5.04059 0.956794 5.01077 1.00146 4.98242L0.878418 5.06738ZM2.59033 4.9707C2.5939 4.99784 2.59877 5.02508 2.60303 5.05273C2.58752 4.95228 2.57623 4.85554 2.56982 4.76074L2.59033 4.9707ZM2.67432 3.64844C2.63053 3.82308 2.59968 4.00283 2.58154 4.18652C2.59966 4.00317 2.63065 3.82375 2.67432 3.64941V3.64844ZM10.4097 4.11621C10.4236 4.2614 10.4312 4.40873 10.4312 4.55762L10.4263 4.33594C10.4227 4.2622 10.4167 4.18898 10.4097 4.11621ZM10.2759 3.37988C10.265 3.33905 10.2547 3.29817 10.2427 3.25781C10.2547 3.29817 10.265 3.33905 10.2759 3.37988ZM2.98975 2.82422C2.96252 2.87574 2.93744 2.92847 2.9126 2.98145C2.96234 2.87537 3.01653 2.77195 3.07568 2.67188L2.98975 2.82422ZM10.2046 3.14062C10.1947 3.11035 10.1858 3.07979 10.1753 3.0498C10.1858 3.07979 10.1947 3.11034 10.2046 3.14062ZM10.1411 2.95801C10.1273 2.9211 10.1139 2.88409 10.0991 2.84766C10.1139 2.88409 10.1273 2.9211 10.1411 2.95801ZM10.062 2.75977C10.0464 2.72343 10.0307 2.68719 10.0142 2.65137C10.0307 2.68719 10.0464 2.72343 10.062 2.75977ZM9.95264 2.52441C9.94462 2.50839 9.93642 2.49247 9.92822 2.47656C9.93643 2.49247 9.94462 2.50839 9.95264 2.52441ZM9.86865 2.36426C9.85202 2.33411 9.83517 2.30412 9.81787 2.27441C9.83517 2.30412 9.85201 2.33411 9.86865 2.36426ZM3.85107 1.75V1.75098V1.75ZM9.75635 2.17285C9.7391 2.14494 9.72145 2.11733 9.70361 2.08984C9.72145 2.11733 9.73909 2.14494 9.75635 2.17285ZM9.66846 2.03613C9.64085 1.99488 9.6124 1.9543 9.5835 1.91406C9.61241 1.9543 9.64085 1.99488 9.66846 2.03613ZM9.53662 1.85059C9.51758 1.82504 9.49857 1.79952 9.479 1.77441C9.49857 1.79952 9.51758 1.82504 9.53662 1.85059ZM9.27002 1.52441C9.23741 1.48834 9.20415 1.45292 9.17041 1.41797C9.20415 1.45292 9.23741 1.48834 9.27002 1.52441ZM9.14014 1.3877C9.10362 1.35059 9.06658 1.31408 9.02881 1.27832C9.06658 1.31408 9.10362 1.35059 9.14014 1.3877ZM8.9751 1.22852C8.95061 1.20608 8.92586 1.18397 8.90088 1.16211C8.92586 1.18397 8.9506 1.20608 8.9751 1.22852ZM5.38721 0.992188V0.993164V0.992188ZM8.81787 1.09082C8.79047 1.06802 8.76281 1.04556 8.73486 1.02344C8.76281 1.04556 8.79047 1.06802 8.81787 1.09082ZM6.79443 0.989258C6.90039 1.01105 7.0046 1.03801 7.10693 1.06934C6.95437 1.02262 6.79757 0.986213 6.63721 0.960938L6.79443 0.989258ZM8.65186 0.958984C8.6245 0.938374 8.59669 0.918399 8.56885 0.898438C8.59669 0.918399 8.6245 0.938374 8.65186 0.958984ZM6.45459 0.9375C6.48862 0.941006 6.52241 0.9457 6.55615 0.950195C6.46533 0.938091 6.37359 0.928678 6.28076 0.923828L6.45459 0.9375ZM8.49365 0.845703C8.46051 0.822983 8.42684 0.801094 8.39307 0.779297C8.42684 0.801093 8.46051 0.822984 8.49365 0.845703ZM8.31494 0.729492C8.28499 0.711057 8.25453 0.693487 8.22412 0.675781C8.25453 0.693487 8.28499 0.711058 8.31494 0.729492ZM8.13135 0.623047C8.09932 0.605449 8.06717 0.588076 8.03467 0.571289C8.06717 0.588075 8.09931 0.60545 8.13135 0.623047ZM7.9585 0.532227C7.92623 0.516372 7.89354 0.501378 7.86084 0.486328C7.89354 0.501378 7.92623 0.516373 7.9585 0.532227ZM7.5835 0.370117C7.46282 0.32465 7.33974 0.284432 7.21436 0.25C7.33974 0.284432 7.46282 0.324651 7.5835 0.370117ZM7.17139 0.238281C7.12261 0.225443 7.07334 0.214238 7.02393 0.203125C7.07334 0.214239 7.12261 0.225442 7.17139 0.238281ZM6.96143 0.188477C6.91876 0.179565 6.87563 0.172645 6.83252 0.165039C6.87563 0.172645 6.91876 0.179565 6.96143 0.188477ZM6.3208 0.105469C6.46603 0.113058 6.60933 0.128366 6.75049 0.150391C6.60966 0.12842 6.46666 0.11307 6.32178 0.105469L6.09912 0.0996094L6.3208 0.105469ZM0.115723 6.89453C0.122559 6.94856 0.131684 7.00263 0.143066 7.05664C0.131684 7.00263 0.122562 6.94855 0.115723 6.89453ZM10.3247 3.5791C10.3153 3.53595 10.3061 3.49287 10.2954 3.4502C10.3061 3.49287 10.3153 3.53595 10.3247 3.5791ZM7.39795 1.17383C7.36076 1.15867 7.32344 1.14377 7.28564 1.12988C7.32344 1.14376 7.36076 1.15868 7.39795 1.17383ZM7.74756 0.435547C7.7137 0.42115 7.6793 0.408063 7.64502 0.394531C7.6793 0.408062 7.7137 0.42115 7.74756 0.435547Z" fill="white" fill-opacity="0.32"/>
            </svg>
        </a>

       <div className={cls.upContainer}>
            <div className={cls.headerPhoto} style={{backgroundColor: getAvatarColor()}}>
               {photoUrl ? (
                <Image src={photoUrl} alt='' width={60} height={60} style={{borderRadius: '50%'}}/>
               ) : (
                <span className={cls.profileHeader}>
                    {usernameInitial.slice(0,1).toUpperCase()}
                </span>
               )}
            </div>
            <div className={cls.balance}>
                <div className={cls.profileBalance}>
                    <Image src={ton} alt="balance" width={20} height={20} />
                    <span className={cls.tonBalance}>{1000}</span>
                </div>
                <span className={cls.balanceSubtitle}>Всего выиграно</span>
            </div>
       </div>
        
       
        <span className={cls.name}>John Doe</span>
        <span className={cls.userId}>
            <span>User ID {12345}</span>
            <Image src={copyImage} alt='' height={10} width={8.6}></Image>
        </span>

        <Deposit></Deposit>
        <Promocodes></Promocodes>
    </div>
  );
};

export default ProfilePage;